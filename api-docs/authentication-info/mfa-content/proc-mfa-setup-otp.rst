.. _config-mfa-otp-device:

Set up multi-factor authentication by OTP device
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Use these instructions to configure a Rackspace Cloud account for
multi-factor authentication by using an OTP (one-time password) device.

During the set up process, use the QR code generated by the Rackspace
Identity service to register the OTP device with a mobile passcode
application. If you don't have an application available, download and
install one of these:

-  `Google
   Authenticator <https://support.google.com/accounts/answer/1066447?hl=en>`__

-  `Authy <https://www.authy.com/users>`__

-  `Duo Mobile <https://www.duosecurity.com/product/methods>`__

Run the following sequence of API operations to create, enable, and use
an OTP device for multi-factor authentication.

#. Authenticate to the Identity service.

    ..  note:: 
   
        If you have multi-factor authentication configured on your account,
   	    follow the :ref:`multi-factor authentication process <auth-mfa-enabled-account>` 
   	    to get the authentication token.
   	    

    .. code::  

       $ curl https://identity.api.rackspacecloud.com/v2.0/tokens \
              -X POST \
              -H "Accept: application/json" \
              -d '{"auth": {"passwordCredentials": {"username":"jqsmith", "password":"Password1"}}}' \ 
              -H "Content-Type: application/json"

   The Identity service returns a 200 response that includes the
   authentication token ID.

    .. code::  

       < HTTP/1.1 200 OK
       < Vary:  Accept, Accept-Encoding, X-Auth-Token
       < Content-Type: application/json
       < Content-Length: 375
       < Server: Jetty(6.1.25)
       < 
       {
           "access": {
               "serviceCatalog": [],
               "token": {
                   "RAX-AUTH:authenticatedBy": [
                       "PASSWORD"
                   ],
                   "expires": "YYYY-MM-DDT22:47:04.253-06:00",
                   "id": "xxxxxxxxxxxxxxxxxxx"
               },
               "user": {
                   "RAX-AUTH:defaultRegion": "IAD",
                   "RAX-AUTH:federated": false,
                   "id": "123452047fc14cc7bc977caa3cfff35f",
                   "name": "jqsmith",
                   "roles": [
                       {
                           "description": "User Admin Role.",
                           "id": "3",
                           "name": "identity:user-admin"
                       }
                   ]
               }
           }
       }

#. Export the authentication token to an environment variables for use
   in subsequent operations.

   .. code::  

       $ EXPORT AUTH_TOKEN="9b830c07c29f4d17a7e53d2341302218"
       

#. Add an OTP device to your account.

   .. code::  

       $ curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/otp-devices  \
              -X POST \
              -H "Content-Type: application/json" \
              -H "X-Auth-Token: $AUTH_TOKEN"
              -d '{"RAX-AUTH:otpDevice": { "name": "NewOTPDevice" }}' \ 
              | python -m json.tool

   The Identity service returns a 201 response that includes a
   system-generated device ID and a QR code that you can use to add the
   device to the mobile passcode application.

   .. code::  

       < HTTP/1.1 201 Created
       < Vary:  Accept, Accept-Encoding, X-Auth-Token
       < Location: http://identity.api.rackspacecloud.com/cloud/v2.0/users/92bb036af5b0467198cded345597f6b4/RAX-AUTH/multi-factor/otp-devices/922e1bc14a0f4c9d94b2f26032312345
       < Content-Type: application/json
       < Content-Length: 93
       < Server: Jetty(6.1.25)
       <
       {
           "RAX-AUTH:otpDevice": {
               "id": "94a1edf3bbe24cbc959512d46c112345",
               "keyUri": "otpauth://totp/Rackspace:myMobilePhone%20OTP1%20otp2?secret=SEIMNMGTH44S3ECHINDPU6OO7Y5IMJZM&issuer=Rackspace",
               "name": "myMobilePhone OTPdevice",
               "qrcode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKAAQAAAAAktvSOAAADPUlEQVR42u3dQXLqMAwAULPiGByVHjXHYIV/hyaO5MSt6XT157HpQMljp4lkSSn1j18FCAQCgUAgEAgEAoFAIBAI/M/BR9lfl9cnH5fXh/f1f+u7Z7l+/e/1lXDRDQgEAufA7ZMv6bZdVBuR3RK+Ei8HAoHAH8GPcvK1jS+f7tIiVQPbrwCBQOAvwBCpSnmFrz201U/3foxpQCAQ+AvwdVEiMv+RsjcgEAh8D4yp2Zp+xSzssReJ6vu5HhAIBJ6UnWNO9t2f6To2EAgEDk7Gl3Zf1L4d6s1r+HrnjB4IBAJz+GpBab1ZKpfuipahrfWgVhYCAoHAKfAWasrxnql0764hGVslIBAInAbrfl+015RrCFF1LwQt6Z5pv4MCAoHASfC0Abn1IV+/zrrCu/UcrAKBQOBb4HZ0VbqA9dgLQeUSo9h+zg4EAoGT4DpjFYYfthmIEn+lhNSsbDdSqaMQCAQCfwDPT8j70k9O4lr1uYz7D4FAIPDkZukaMq3UEpgHr/aB8woEAoFvg93UQ25HTmXn0spCoXkQCAQCZ8HWuRPbcp5du2AoEm2p2WXQfwgEAoGjQtAjjVP15+zxkCtOY31TdgYCgcBjIag+97pObheM116P/YXDuVEgEAg8ZlJLGn5YBqlZOOvqMzQgEAicAmvoNT4eqceSdLut2r9yPgoBBAKBp/02keh3Gm8RLi/ySn+AQCBwAqxdGFq6EFXT3Hl97gfsZZSaAYFA4GB3333g9onaEk63ZkYhgEAg8GSFxcmcQ5+a3Y6tyt/sxAACgcBDapY2kN5zV0+IYv3DZca5HhAIBA7B2BlYDk92yDu77nmEAggEAqfBPOdQu0OupaVm/a5SIBAInATzK2wZzXGrO2dPGRoQCAROgP0jY/KW0RIejpeHJh6j1aNAIBA4XJhT20X12CeYN3j1uVwd330BgUDg4ZArzFj1T2+o9SSmlZN9XkAgEPgWWNIKi3KWmpWwrOvn8AUEAoGD8FXbCVZrQC7dg8UPZSEgEAicAWso9tzC6tHH/iyqvFY9DpwDgUDgJJjLznn3Vtw5WrpNFsPwBQQCgYMZ8D95AYFAIBAIBAKBQCAQCAQCgf8r+A/urJ6oeL",
               "verified": false
           }
       }

#. Export ``id`` and ``qrcode`` to environment variables for use in
   subsequent operations.

   .. code::  

       $ EXPORT DEVICE_ID="94a1edf3bbe24cbc959512d46c112345

   .. code::  

       $ EXPORT qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKAAQAAAAAktvSOAAADPUlEQVR42u3dQXLqMAwAULPiGByVHjXHYIV/hyaO5MSt6XT157HpQMljp4lkSSn1j18FCAQCgUAgEAgEAoFAIBAI/M/BR9lfl9cnH5fXh/f1f+u7Z7l+/e/1lXDRDQgEAufA7ZMv6bZdVBuR3RK+Ei8HAoHAH8GPcvK1jS+f7tIiVQPbrwCBQOAvwBCpSnmFrz201U/3foxpQCAQ+AvwdVEiMv+RsjcgEAh8D4yp2Zp+xSzssReJ6vu5HhAIBJ6UnWNO9t2f6To2EAgEDk7Gl3Zf1L4d6s1r+HrnjB4IBAJz+GpBab1ZKpfuipahrfWgVhYCAoHAKfAWasrxnql0764hGVslIBAInAbrfl+015RrCFF1LwQt6Z5pv4MCAoHASfC0Abn1IV+/zrrCu/UcrAKBQOBb4HZ0VbqA9dgLQeUSo9h+zg4EAoGT4DpjFYYfthmIEn+lhNSsbDdSqaMQCAQCfwDPT8j70k9O4lr1uYz7D4FAIPDkZukaMq3UEpgHr/aB8woEAoFvg93UQ25HTmXn0spCoXkQCAQCZ8HWuRPbcp5du2AoEm2p2WXQfwgEAoGjQtAjjVP15+zxkCtOY31TdgYCgcBjIag+97pObheM116P/YXDuVEgEAg8ZlJLGn5YBqlZOOvqMzQgEAicAmvoNT4eqceSdLut2r9yPgoBBAKBp/02keh3Gm8RLi/ySn+AQCBwAqxdGFq6EFXT3Hl97gfsZZSaAYFA4GB3333g9onaEk63ZkYhgEAg8GSFxcmcQ5+a3Y6tyt/sxAACgcBDapY2kN5zV0+IYv3DZca5HhAIBA7B2BlYDk92yDu77nmEAggEAqfBPOdQu0OupaVm/a5SIBAInATzK2wZzXGrO2dPGRoQCAROgP0jY/KW0RIejpeHJh6j1aNAIBA4XJhT20X12CeYN3j1uVwd330BgUDg4ZArzFj1T2+ourJ6oeLlkhwAAAABJRU5ErkJggg=="

#. Add the QR code to the mobile passcode application by manually
   copying and pasting the ``qrcode`` value.

   For mobile passcode applications installed on a mobile phone, you can
   scan the QR code image into the application. To use this method,
   create a file with the following html code

   .. code::  

       <html>
       <img alt="QR Code" src="$qrcode"/>
       </html> 

   Replace the ``$qrcode`` variable with the value that you exported
   from the response to the create device API request. Then, open the
   page in a browser window, and use the scan feature in the mobile
   passcode application to confirm the pairing of the OTP device and the
   mobile passcode generator.

   This example shows an OTP device added to the Google Authenticator
   application on a mobile phone.

   .. figure::  ../_images/otp-device.png
      :alt: Rackspace Cloud OTP device configured in the Google Authenticator application.
   

#. To verify the device, send the passcode generated by mobile passcode
   application to the OTP device.

   .. code::  

       $ curl identity.api.rackspacecloud.com/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/otp-devices/$DEVICE_ID/verify \
                         -X POST \
                         -d '{"RAX-AUTH:verificationCode": { "code": "$MOBILE_PASSCODE" }}' \
                         -H "Content-type: application/json" \
                         -H "X-Auth-Token: $TOKEN" -| python -m json.tool
           

   The Identity service returns a 204 response.

   .. code::  

                           
                            HTTP/1.1 204 No Content
                           
                       

   If you provide an invalid or expired passcode, the Identity service
   returns an error message.
   ``400 The pin provided is either invalid or expired/``. To fix the
   problem, wait for the passcode in the mobile passcode application to
   refresh, then resubmit the verify request.

#. Check account information and turn on multi-factor authentication if
   necessary.

   .. code::  

       $ curl $AUTH_URL/v2.0/users/$USER_ID \
              -X GET \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -H "X-Auth-Token: $AUTH_TOKEN" \
              | python -m json.tool

   The Identity service returns the user account information.

   .. code::  

       {< HTTP/1.1 200 OK
       < Vary:  Accept, Accept-Encoding, X-Auth-Token
       < Content-Type: application/json
       < Content-Length: 375
       < Server: Jetty(6.1.25)

       "user":
       {"rax-auth:domainId":"5830280"
       "id": "123456",
       "enabled": true,
       "username": "jqsmith",
       "email": "john.smith@example.org",
       "rax-auth:defaultRegion":"DFW"
       }
       } 

   If the ``rax-auth:multiFactorEnabled`` attribute is missing or set to
   ``false``, update the account to enable it.

   .. code::  

       $ curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor \
              -X PUT \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d '{"RAX-AUTH:multiFactor": {"enabled": true }}' \
              -H "X-Auth-Token: $AUTH_TOKEN" \
              | python -m json.tool

#. Update the multi-factor authentication settings to use the OTP device
   for authentication.

   .. code::  

       $ curl identity.api.rackspacecloud.com/v2.0/users/$USER_ID/RAX-AUTH/multi-factor \
              -X PUT \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d '{"RAX-AUTH:multiFactor": {"factorType": "OTP" }}' \
              -H "X-Auth-Token: $AUTH_TOKEN" \
              | python -m json.tool

   The Identity service returns a 204 response if the operation is
   successful.

   .. code::  

                           
                            HTTP/1.1 204 No Content
                           
                       

   After you change the multi-factor authentication method, authenticate
   again to get a new token.

#. Submit an authentication request with username and passcode
   credentials.

   .. code::  

       $ curl identity.api.rackspacecloud.com/v2.0   \
              -X POST \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d  '{"auth": {"passwordCredentials": {"username": "$USERNAME","password":"$PASSWORD"}}}'  \
              | python -m json.tool

   The Identity service returns a 401 response with a ``sessionId``
   header and a message requesting additional credentials.

   .. code::  

       < HTTP/1.1 401 Unauthorized
       < Content-Type: application/json
       < Transfer-Encoding: chunked
       < WWW-Authenticate: OS-MF sessionId='ABCDEtwrk4kUsZbPhiXrAD1uMR8B3fsTV6axb6XuddCRl1xsopPla6tSofC0wqWTuc39GzdeDnEUX9xTRM_QA_oYBaN2W9C782YY4-iyQUgqbCFrWbC5ezeEoDVWpWNyR6PARZJQsd7J5QktDQzB7zIwwFvwJVciFEb8kscU87-LNr-u8h7NwtYp30fqNLCZznPtbGWkGC2Pm', factor='PASSCODE'
       < X-NewRelic-App-Data: PxQDVVVTDAATV1BXBAACVUYdFGQHBDcQUQxLA1tMXV1dORYzVBJHNQFUZAQUFVFQVThOFlhaUggXER5jLTU3SxJOCEwIFAQcA1QLUwVNHlNIFAZZUgZaVlVUUAADUFYFVgYUbg=='
       < vary: Accept, Accept-Encoding, X-Auth-Token
       {
           "unauthorized": {
               "code": 401,
               "message": "Additional authentication credentials required"
           }
       } 

#. Submit a second authentication request with ``sessionId`` and
   ``passcode`` credentials.

   -  Export the ``sessionId`` from the header in the initial
      authentication response.

      .. code::  

          $EXPORT SESSION_ID="AABCDEtwrk4kUsZbPhiXrAD1uMR8B3fsTV6axb6XuddCRl1xsopPla6tSofC0wqWTuc39GzdeDnEUX9xTRM_QA_oYBaN2W9C782YY4-iyQUgqbCFrWbC5ezeEoDVWpWNyR6PARZJQsd7J5QktDQzB7zIwwFvwJVciFEb8kscU87-LNr-u8h7NwtYp30fqNLCZznPtbGWkGC2Pm"

   -  Include the session ID header and passcode from the mobile
      passcode application in the authentication request.

      .. code::  

          $ curl identity.api.rackspacecloud.com/v2.0/tokens   \
                 -X POST \
                 -H "Content-Type: application/json" \
                 -H "Accept: application/json" \
                 -d '{"auth": {"RAX-AUTH:passcodeCredentials": {"passcode":"$MOBILE_PASSCODE"}}}'  \
                 -H "X-SessionId: $SESSION_ID"
                 -H "X-Auth-Token: $AUTH_TOKEN" \
                 | python -m json.tool

      In the authentication response, the token authentication method is
      ``OTPPASSCODE``.

      .. code::  

          < HTTP/1.1 200 OK
          < Vary:  Accept, Accept-Encoding, X-Auth-Token
          < Content-Type: application/json
          < Content-Length: 375
          < Server: Jetty(6.1.25)
          < 
          {
              "access": {
                  "serviceCatalog": [],
                  "token": {
                      "RAX-AUTH:authenticatedBy": [
                          "OTPPASSCODE",
                          "PASSWORD"
                      ],
                      "expires": "2015-04-04T14:17:51.918Z",
                      "id": "$TOKEN",
                      "tenant": {
                          "id": "2014073001",
                          "name": "2014073001"
                      }
                  },
                  "user": {
                      "RAX-AUTH:defaultRegion": "IAD",
                      "id": "xxxxxxxxxxxxxxxxxxx",
                      "name": "jqsmith",
                      "roles": [
                                         {
                              "description": "A Role that allows a user access to keystone Service methods",
                              "id": "684",
                              "name": "compute:default",
                              "tenantId": "2014073001"
                          },
                          {
                              "description": "A Role that allows a user access to keystone Service methods",
                              "id": "5",
                              "name": "object-store:default",
                              "tenantId": "StagingUS_2014073001"
                          },
                          {
                              "description": "User Admin Role.",
                              "id": "3",
                              "name": "identity:user-admin"
                               }
                      ]
                  }
              }

For more information, see the following topics:

-  :ref:`Authenticate from a multifactor-enabled user account <auth-mfa-enabled-account>`

-  :ref:`Manage multifactor-enabled accounts <auth-mfa-manage-accounts>`

-  :ref:`API reference: Multi-factor authentication operations <multifactor-operations>` 